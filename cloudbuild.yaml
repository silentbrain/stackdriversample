steps:
#Copy Source Code to Bucket
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['auth', 'list']
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['-m', 'cp', '-r', './*', 'gs://kty-test1/git/']
  id: 'gcs-copy'

#First Deploy for SSH init
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['compute', 'ssh', 'pping@kty-instance-2', '--zone', 'asia-northeast3-a', '--ssh-flag', '-p 10022', '--command', 'gsutil -m cp -r gs://kty-test1/git /hosting/pping/ && gsutil cp gs://kty-test1/after.sh /hosting/pping/ && sh /hosting/pping/after.sh']
  id: 'init-for-ssh'
  waitFor: ['gcs-copy']
  
#After Deploy parallel
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['compute', 'ssh', 'pping@kty-instance-3', '--zone', 'asia-northeast3-a', '--ssh-flag', '-p 10022', '--command', 'gsutil -m cp -r gs://kty-test1/git /hosting/pping/ && gsutil cp gs://kty-test1/after.sh /hosting/pping/ && sh /hosting/pping/after.sh']
  waitFor: ['init-for-ssh']
  
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['compute', 'ssh', 'pping@kty-instance-4', '--zone', 'asia-northeast3-a', '--ssh-flag', '-p 10022', '--command', 'gsutil -m cp -r gs://kty-test1/git /hosting/pping/ && gsutil cp gs://kty-test1/after.sh /hosting/pping/ && sh /hosting/pping/after.sh']
  waitFor: ['init-for-ssh']