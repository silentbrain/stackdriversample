substitutions:
  _GIT_BUCKET: 'gs://kty-test1/git' #Destination bucket for git clone ex) gs://pping-cloudbuild-prd/sourcebuild/_sc
  _SCRIPT_BUCKET: 'gs://kty-test1' #Script bucket ex) gs://pping-cloudbuild-prd/deploy_scripts
  _SCRIPT_FILE: 'after.sh' #Script file name for script for ex) _sc-deploy.sh
  _LOCAL_PATH: '/hosting/pping' #Destination of Instance local disk for Source code & script copy

steps:
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['-m', 'rm', '-r', '$_GIT_BUCKET/']
  id: 'bucket-init'

- name: 'gcr.io/cloud-builders/gsutil'
  args: ['-m', 'cp', '-r', './*', '$_GIT_BUCKET/']
  id: 'gcs-copy'
  waitFor: ['bucket-init']

- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      gcloud auth list
      gcloud compute instances list --format="csv(name,zone.basename(),status)" | grep RUNNING | grep kty- > /deploy/list.csv
      echo "Listing active kty prefix instances"
      echo "===================="
      cat /deploy/list.csv
      sh make-deploy.sh
      cat /deploy/deploy.yaml
  volumes:
  - name: 'deploy'
    path: '/deploy'
  id: 'build-deploy'
  waitFor: ['gcs-copy']

- name: 'gcr.io/cloud-builders/gcloud'
  args: ['builds', 'submit', '--no-source', '--async', '--config', '/deploy/deploy.yaml', '--substitutions', '_TRIGGER_BUILD=$BUILD_ID,_TRIGGER_REPO=$REPO_NAME,_TRIGGER_COMMIT=$COMMIT_SHA,_GIT_BUCKET=$_GIT_BUCKET,_SCRIPT_BUCKET=$_SCRIPT_BUCKET,_SCRIPT_FILE=$_SCRIPT_FILE,_LOCAL_PATH=$_LOCAL_PATH' ]
  volumes:
  - name: 'deploy'
    path: '/deploy'
  id: 'submit-deploy'
  waitFor: ['build-deploy']